#!/bin/bash
# $1: configuration file.
# If the first argument is missing and there is a
# "$(pwd)/config/setup" file, then it will be used by default.
CONFIG_FILE=$1

# Attempt to use default configuration if the argument has not been supplied
if [ -z "$CONFIG_FILE" ] && [ -f "$(pwd)/config/setup" ]; then
    CONFIG_FILE=$(pwd)/config/setup
elif [ -z "$CONFIG_FILE" ]; then
    echo "Path to configuration file as first arg necessary."
    exit 1
fi

# First argument is the path/to/config.sh
source $CONFIG_FILE

WWW_PATH=$HEX_CALC/www
BASEARGS='--master --callable app --processes 2 --threads 100 --wsgi-file '$WWW_PATH/www.py' --pidfile '$HEX_CALC/www.pid

if [ $USE_HTTPS == 1 ]; then
    SOCKETARGS='--https-socket '$WWW_SOCKET,$CERT,$KEY,HIGH,$CA
else
    SOCKETARGS='--http-socket '$WWW_SOCKET
fi

if [ $BACK_OR_FOREGROUND == "FORE" ]; then
    uwsgi $BASEARGS $SOCKETARGS
else
    (nohup uwsgi $BASEARGS $SOCKETARGS &> $HEX_CALC/www.log &)
fi
