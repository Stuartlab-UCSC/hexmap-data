#!/bin/bash
# Make your virtualenv as specified by $PYENV path
# $1: the optional path to the localpy bin dir, defaults to $HOME/.local/bin

# Check for the main env var.
if [[ -z $HEXCALC ]]; then
   echo "Environment variable HEXCALC must be defined to run this script."
   echo "Do you want to run sudo startAsRoot?"
   exit 1
fi

source $HEXCALC/ops/config.sh

LOCALPY_BIN=$1
if [ $(uname -s) == "Darwin" ]; then

    # On macOS this is always here.
    # Virt envs are difficult on mac, just use the system python.
    LOCALPY_BIN=/usr/bin
elif [ -z ${LOCALPY_BIN} ]; then # use the default
    LOCALPY_BIN=$HOME/.local/bin
fi

# Start off pointing to only the newly installed python to minimize path
# problems/confusion
PATH=$LOCALPY_BIN:$PATH

echo 'LOCALPY_BIN:'
echo $LOCALPY_BIN
echo 'pip:'
which pip
echo 'virtualenv:'
which virtualenv

mkdir $PYENV
virtualenv $PYENV 

if [ $? != 0 ]; then
   exit $?
fi
# Add calc, www, and db dirs to the python path in the virtual environment
# TODO the below path should be more strict by not including PATH from user's
# environment
echo "export PATH=$PYENV/bin:$DRLPATH:$PATH" >> $PYENV/bin/activate
echo "export PYTHONPATH=$HEXCALC/www:$HEXCALC/www/adapters:$HEXCALC/www/job:$HEXCALC/www/project:$HEXCALC/www/upload:$HEXCALC/calc:$HEXCALC/db:$TETE_PATH:$DRLPATH" >> $PYENV/bin/activate

cd $HEXCALC

# Activate the python environment and install the requirements.
source $PYENV/bin/activate
pip install -r $HEXCALC/build/requirements.txt

echo
echo 'python:'
which python
echo 'pip:'
which pip

